# ConfigMap wso2am-gateway-conf
apiVersion: v1
kind: ConfigMap
metadata:
   name: kcb-wso2apim-gateway-conf
   namespace: kcb-wso2apim
data:
   deployment.toml: |-
      [server]      
      hostname = "gateway.am.wso2.com"
      node_ip = "$env{NODE_IP}"
      server_role = "gateway-worker"
      offset=4
      
      [user_store]
      type = "database_unique_id"

      [super_admin]
      username = "admin"
      password = "admin"
      create_admin_account = true

      [database.shared_db]
      type = "mysql"
      url ="jdbc:mysql://kcb-wso2am-mysql-db-service:3306/WSO2AM_SHARED_DB?useSSL=false&amp;autoReconnect=true&amp;requireSSL=false&amp;verifyServerCertificate=false"
      username = "wso2carbon"
      password = "wso2carbon"
      driver = "com.mysql.cj.jdbc.Driver"

      [keystore.tls]
      file_name =  "wso2carbon.jks"
      type =  "JKS"
      password =  "wso2carbon"
      alias =  "wso2carbon"
      key_password =  "wso2carbon"

      [truststore]
      file_name = "client-truststore.jks"
      type = "JKS"
      password = "wso2carbon"

      # key manager implementation
      [apim.key_manager]
      service_url = "https://kcb-wso2apim-km-service:9443/services/"
      username= "$ref{super_admin.username}"
      password= "$ref{super_admin.password}"

      # JWT Generation
      [apim.jwt]
      enable = true
      encoding = "base64" # base64,base64url
      #generator_impl = "org.wso2.carbon.apimgt.keymgt.token.JWTGenerator"
      claim_dialect = "http://wso2.org/claims"
      header = "X-JWT-Assertion"
      signing_algorithm = "SHA256withRSA"
      #enable_user_claims = true
      #claims_extractor_impl = "org.wso2.carbon.apimgt.impl.token.DefaultClaimsRetriever"

      # Traffic Manager configurations
      [apim.throttling]
      username= "$ref{super_admin.username}"
      password= "$ref{super_admin.password}"
      service_url = "https://kcb-wso2apim-tm-service:9446/services/"      
      throttle_decision_endpoints = ["tcp://wso2apim-tm-service:5675"]

      [[apim.throttling.url_group]]
      traffic_manager_urls=["tcp://kcb-wso2apim-tm-service:9614"]
      traffic_manager_auth_urls=["ssl://kcb-wso2apim-tm-service:9714"]

      # Caches
      [apim.cache.gateway_token]
      enable = true
      expiry_time = 15

      [apim.cache.resource]
      enable = true

      [apim.cache.jwt_claim]
      enable = true
      expiry_time = 900

      [apim.oauth_config]
      remove_outbound_auth_header = true
      auth_header = "Authorization"                  

      [apim.cors]
      allow_origins = "*"
      allow_methods = ["GET","PUT","POST","DELETE","PATCH","OPTIONS"]
      allow_headers = ["authorization","Access-Control-Allow-Origin","Content-Type","SOAPAction"]
      allow_credentials = false